<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <!-- 제이쿼리를 사용한다. -->
  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="/css/save.css">
</head>
<body>

<!-- action은 form에 작성한 데이터를 어디로 보낼 것인지 지정한다. -->
<!--  이메일 속성에 id를 써서 중복 여부 처리에 쓴다. onkeyup을 통해 백엔드 쪽으로 보낸다. -->
<form action="/member/save" method="post">
  이메일: <input type="text" name="email" id="memberEmail" onblur="emailCheck()"><br>
  <p id="check_result"></p>
  비밀번호: <input type="password" name="password" id="password"><br>
  비밀번호 확인: <input type="password" name="passwordConfirm" id="passwordConfirm" onkeyup="checkPasswordMatch()"><br>
  <!-- input은 버튼의 일종. -->
  <p id="passwordMatchResult"></p>
  <input type="submit" value="회원가입" id="signupButton" disabled>
</form>

<a id="mainPageLink" href="/">메인 페이지로 이동</a>

<!-- 자바스크립트로 emailCheck를 구현한다. -->
<script th:inline="javascript">
  const emailCheck = () =>{
    const email = document.getElementById("memberEmail").value;
    console.log("입력값: ",email)
    const checkResult = document.getElementById("check_result");
    $.ajax({
      type:"post",
      url:"/member/email-check",
      data:{
        "memberEmail":email
      },
      success:function(res){
        console.log("요청성공",res);
        if(res==="ok"){
          checkResult.style.color = "green";
          checkResult.innerHTML="사용가능한 이메일";
        } else {
          checkResult.style.color = "red";
          checkResult.innerHTML="이미 사용중인 이메일입니다.";
        }
      },
      error:function(err){
        console.log("에러발생",err);
      }
    });
  }
  
  // 비밀번호 확인을 위한 코드.
  $(document).ready(function() {
    $("#passwordConfirm").on("keyup blur", checkPasswordMatch);

    $("#signupButton").click(function(e) {
      e.preventDefault();
      
      const password = $("#password").val();
      const confirmPassword = $("#passwordConfirm").val();

      $.ajax({
        type: "post",
        url: "/save",
        data: {
          email: $("#memberEmail").val(),
          password: password,
          passwordConfirm: confirmPassword
        },
        success: function(res) {
          if (res === "회원가입이 완료되었습니다.") {
        	  alert(res); // 또는 다른 알림 방식 사용 가능
            window.location.href = "/"; //메인 페이지로 이동
          } else {
        	alert("회원가입에 실패했습니다."); // 실패 시 알림 처리
            window.location.href = "/save"; //메인 페이지로 이동
          }
        },
        error: function(err) {
          console.error("에러 발생", err);
        }
      });
    });
  });

  // 비밀번호 일치 여부 확인 함수
  function checkPasswordMatch() {
    const password = $("#password").val();
    const confirmPassword = $("#passwordConfirm").val();
    const matchResult = $("#passwordMatchResult");
    const signupButton = $("#signupButton");

    if (password === confirmPassword) {
      matchResult.css("color", "green").html("비밀번호 일치");
      signupButton.prop("disabled", false);
    } else {
      matchResult.css("color", "red").html("비밀번호 불일치");
      signupButton.prop("disabled", true);
    }
  }
</script>

</body>
</html>